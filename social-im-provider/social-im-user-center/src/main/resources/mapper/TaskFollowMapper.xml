<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.enuos.live.mapper.TaskFollowMapper">

    <!--获取任务进度-->
    <select id="getProgress" resultType="java.util.Map">
        select
        code,
        progress
        from tb_task_follow
        where user_id = #{userId} and code like concat(#{prefix}, '%')
    </select>

    <!--任务追踪-->
    <select id="getTaskFollow" parameterType="java.util.Map" resultType="java.util.Map">
        select user_id userId, code, progress from tb_task_follow where user_id = #{userId} and code = #{code}
    </select>

    <!--保存记录-->
    <insert id="save" parameterType="java.util.Map" useGeneratedKeys="true">
        insert into tb_task_follow (user_id, code, progress) values (#{userId}, #{code}, #{progress})
    </insert>

    <!--更新进度-->
    <update id="updateProgress" parameterType="java.util.Map">
        update tb_task_follow set progress = #{progress} where user_id = #{userId} and code = #{code}
    </update>
    
    <!--成就进度记录-->
    <select id="getAchievementFollowList" resultType="java.util.Map">
        select 
        user_id userId, 
        code, 
        progress 
        from tb_task_follow
        where user_id = #{userId}
        and code in
        <foreach collection="list" item="item" open="(" separator="," close=")">
            #{item.code}
        </foreach>
    </select>

    <!--批量保存记录-->
    <insert id="batchSave" useGeneratedKeys="true">
        insert into tb_task_follow (user_id, code, progress) values
        <foreach collection="list" item="item" separator=",">
            (#{userId}, #{item.code}, #{item.progress})
        </foreach>
    </insert>

    <!--批量更新进度-->
    <update id="batchUpdateProgress">
        update tb_task_follow
        <trim prefix="set" suffixOverrides=",">
            <trim prefix="progress = case" suffix="end,">
                <foreach collection="list" item="item">
                    when code = #{item.code} then #{item.progress}
                </foreach>
            </trim>
        </trim>
        <where>
            and user_id = #{userId}
            and code in
            <foreach collection="list" item="item" open="(" separator="," close=")">
                #{item.code}
            </foreach>
        </where>
    </update>
</mapper>