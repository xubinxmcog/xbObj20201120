<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.enuos.live.mapper.TaskSignMapper">

    <select id="getSignDescription" resultType="java.util.Map">
        select
        distinct
        t1.description,
        t2.suffix
        from tb_task t1
        left join tb_task_reward t2 on t1.code = t2.task_code
        where t1.category = 2
        order by t2.suffix
    </select>

    <!--获取签到次数-->
    <select id="getSignCount" resultType="java.util.Map">
        select
        t1.sign_count signCount,
        t1.continue_sign_count continueSignCount,
        t1.back_sign_count backSignCount,
        t2.vip,
        date_format(t2.expiration_time, '%Y-%m-%d %T') expirationTime,
        t3.exclusive_num vipGold
        from tb_task_sign t1
        left join tb_user_account_attach t2 on t2.user_id = t1.user_id
        left join tb_member_interest t3 on t3.vip = t2.vip and t3.code = 'MI07'
        <where>
            and t1.user_id = #{userId}
            and t1.code = #{code}
        </where>
    </select>

    <!--获取签到信息-->
    <select id="getTaskSign" parameterType="com.enuos.live.pojo.TaskSign" resultType="com.enuos.live.pojo.TaskSign">
        select
        t1.user_id userId,
        t1.code,
        t1.sign_time signTime,
        t1.sign_count signCount,
        t1.continue_sign_count continueSignCount,
        t1.back_sign_count backSignCount,
        t2.sign_type signType
        from tb_task_sign t1
        left join tb_task_sign_record t2 on t2.user_id = t1.user_id and t2.code = t1.code and t2.sign_time = t1.sign_time
        <where>
            and t1.user_id = #{userId}
            and t1.code = #{code}
        </where>
    </select>

    <!--签到-->
    <insert id="saveTaskSign" parameterType="com.enuos.live.pojo.TaskSign" useGeneratedKeys="true">
        insert into tb_task_sign
        <trim prefix="(" suffix=")" suffixOverrides=",">
            user_id,
            code,
            <if test="signTime != null">
                sign_time,
            </if>
            <if test="signCount != null">
                sign_count,
            </if>
            <if test="continueSignCount != null">
                continue_sign_count,
            </if>
            <if test="backSignCount != null">
                back_sign_count
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{userId},
            #{code},
            <if test="signTime != null">
                #{signTime},
            </if>
            <if test="signCount != null">
                #{signCount},
            </if>
            <if test="continueSignCount != null">
                #{continueSignCount},
            </if>
            <if test="backSignCount != null">
                #{backSignCount}
            </if>
        </trim>
    </insert>

    <!--更新签到-->
    <update id="updateTaskSign" parameterType="com.enuos.live.pojo.TaskSign">
        update tb_task_sign
        <set>
            <if test="signTime != null">
                sign_time = #{signTime},
            </if>
            <if test="signCount != null">
                sign_count = #{signCount},
            </if>
            <if test="continueSignCount != null">
                continue_sign_count = #{continueSignCount},
            </if>
            <if test="backSignCount != null">
                back_sign_count = #{backSignCount},
            </if>
        </set>
        <where>
            and user_id = #{userId}
            and code = #{code}
        </where>
    </update>
</mapper>